blueprint:
  domain: automation

  name: Lutron Pico Paddle - Light with Brightness Control
  description: |
    This automation allows for controlling one or more light entities with a Lutron Paddle Pico (PJ2-1P-GXX).
    A short press will toggle the light on/off, while a long press will gradually adjust brightness.

  input:
    pico:
      name: Pico Remote
      description: "Select the Pico remote to configure:"
      selector:
        device:
          integration: lutron_caseta
    entity:
      name: Light Entity(ies)
      description: "Light entity to control."
      selector:
        entity:
          filter:
            domain: light
          multiple: true
    hold_time:
      name: Hold Time
      description: "A button press of less than this time will brighted/dim the light(s) by the step percentage. More will mimic the press and hold behavior of a dimmer switch."
      default: 250
      selector:
        number:
          min: 100
          max: 1000
          unit_of_measurement: milliseconds
    step:
      name: Brightness Step Percentage
      description: "The percentage to increase/decrease the brightness when the raise/lower button is pressed."
      default: 5
      selector:
        number:
          min: 1
          max: 25
          unit_of_measurement: percent
    step_delay:
      name: Step Cycle Delay
      description: "The amount of time in milliseconds between each brightness step when holding the raise/lower button."
      default: 450
      selector:
        number:
          min: 100
          max: 1000
          unit_of_measurement: milliseconds
    brightness_on:
      name: Brightness On Level
      description: "The brightness percentage to set when the 'On' button is pressed."
      default: 100
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: percent
    transition_on:
      name: Transition On
      description: The transition speed in seconds when turning the light(s) on. If the device has a buit in transition, this will add to it.
      default: 0
      selector:
        number:
          min: 0
          max: 10
          unit_of_measurement: seconds
    transition_off:
      name: Transition Off
      description: The transition speed in seconds when turning the light(s) off. If the device has a buit in transition, this will add to it.
      default: 0
      selector:
        number:
          min: 0
          max: 10
          unit_of_measurement: seconds

variables:
  step_pct: !input step
  buffer_delay: 50

trigger:
  - trigger: device
    device_id: !input pico
    domain: lutron_caseta
    type: press
    subtype: "on"
    id: on_pressed

  - trigger: device
    device_id: !input pico
    domain: lutron_caseta
    type: press
    subtype: "off"
    id: off_pressed

action:
  - choose:
      - conditions:
          - condition: trigger
            id: on_pressed
        sequence:
          - wait_for_trigger:
              - trigger: device
                device_id: !input pico
                domain: lutron_caseta
                type: release
                subtype: "on"
            timeout:
              milliseconds: !input hold_time
            continue_on_timeout: true
          - if:
              - "{{ wait.completed }}"
            then:
              - action: light.turn_on
                target:
                  entity_id: !input entity
                data:
                  brightness_pct: 100
                  transition: !input transition_on
            else:
              - repeat:
                  sequence:
                    - action: light.turn_on
                      data:
                        brightness_step_pct: "{{ step_pct }}"
                      target:
                        entity_id: !input entity
                      continue_on_error: true

                    - wait_for_trigger:
                        - trigger: device
                          device_id: !input pico
                          domain: lutron_caseta
                          type: release
                          subtype: "on"
                      timeout:
                        milliseconds: !input step_delay
                      continue_on_timeout: true
                    - if:
                        - "{{ completed }}"
                      then:
                        - stop:
                    - delay:
                        milliseconds: !input buffer_delay
                  until:
                    - condition: numeric_state
                      entity_id: !input entity
                      attribute: brightness
                      above: 254
      - conditions:
          - condition: trigger
            id: off_pressed
        sequence:
          - wait_for_trigger:
              - trigger: device
                device_id: !input pico
                domain: lutron_caseta
                type: release
                subtype: "off"
            timeout:
              milliseconds: !input hold_time
            continue_on_timeout: true
          - if:
              - "{{ wait.completed }}"
            then:
              - action: light.turn_off
                target:
                  entity_id: !input entity
                data:
                  transition: !input transition_off
            else:
              - repeat:
                  sequence:
                    - action: light.turn_on
                      data:
                        brightness_step_pct: "{{ step_pct * -1 }}"
                      target:
                        entity_id: !input entity
                      continue_on_error: true
                    - wait_for_trigger:
                        - trigger: device
                          device_id: !input pico
                          domain: lutron_caseta
                          type: release
                          subtype: "off"
                      timeout:
                        milliseconds: !input step_delay
                      continue_on_timeout: true
                    - if:
                        - "{{ wait.completed }}"
                      then:
                        - stop:
                    - delay:
                        milliseconds: !input buffer_delay
                  until:
                    - condition: numeric_state
                      entity_id: !input entity
                      attribute: brightness
                      below: 1

mode: restart
